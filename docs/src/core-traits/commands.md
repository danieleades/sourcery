# Commands

Commands represent requests to change the system. Unlike events (which are facts), commands can be rejected. An aggregate validates a command and either produces events or returns an error.

## The `Handle<C>` Trait

```rust,ignore
{{#include ../../../sourcery-core/src/aggregate.rs:handle_trait}}
```

Key points:

- Takes `&self` — the handler reads state but doesn't mutate it
- Returns `Vec<Event>` — a command may produce zero, one, or many events
- Returns `Result` — commands can fail validation

## Command Structs

Commands are plain structs. No traits required:

```rust,ignore
#[derive(Debug)]
pub struct Deposit {
    pub amount: i64,
}

#[derive(Debug)]
pub struct Withdraw {
    pub amount: i64,
}

#[derive(Debug)]
pub struct Transfer {
    pub to_account: String,
    pub amount: i64,
}
```

## Implementing Handlers

Each command gets its own `Handle` implementation:

```rust,ignore
impl Handle<Deposit> for Account {
    fn handle(&self, cmd: &Deposit) -> Result<Vec<Self::Event>, Self::Error> {
        if cmd.amount <= 0 {
            return Err(AccountError::InvalidAmount);
        }
        Ok(vec![FundsDeposited { amount: cmd.amount }.into()])
    }
}

impl Handle<Withdraw> for Account {
    fn handle(&self, cmd: &Withdraw) -> Result<Vec<Self::Event>, Self::Error> {
        if cmd.amount <= 0 {
            return Err(AccountError::InvalidAmount);
        }
        if cmd.amount > self.balance {
            return Err(AccountError::InsufficientFunds);
        }
        Ok(vec![FundsWithdrawn { amount: cmd.amount }.into()])
    }
}
```

The `.into()` call converts your concrete event type into the aggregate's event enum (generated by the derive macro).

## Multiple or No Events

A command can produce multiple events (e.g., closing an account withdraws remaining funds then marks it closed) or no events at all (valid no-op). Return an empty vector for no-ops:

```rust,ignore
if cmd.amount == 0 {
    return Ok(vec![]); // Valid but no change
}
```

## Naming Conventions

Commands are **imperative** because they request an action:

| Good | Bad |
|------|-----|
| `Deposit` | `FundsDeposited` |
| `PlaceOrder` | `OrderPlaced` |
| `RegisterUser` | `UserRegistered` |
| `ChangePassword` | `PasswordChanged` |

## Executing Commands

Use the repository to execute commands:

```rust,ignore
repository
    .execute_command::<Account, Deposit>(&account_id, &Deposit { amount: 100 }, &metadata)
    .await?;
```

## Next

[Projections](projections.md) — Building read models from events
